rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Function to check if the request is coming from a Cloud Function
    function isRequestFromCloudFunction() {
      return request.auth.token.firebase.sign_in_provider == 'custom';
    }
    
    // Function to check if the user owns a document
    function isOwner(resource) {
      return resource.data.uid == request.auth.uid;
    }

    // Only allow Cloud Functions to write to the database
    // Allow users to read their own data
    match /colonies/{colonyId} {
      allow read: if request.auth != null && isOwner(resource);
      allow write: if isRequestFromCloudFunction();
    }
    
    match /tiles/{tileId} {
      allow read: if request.auth != null;
      allow write: if isRequestFromCloudFunction();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 